# Ping Tunnel

ä¸€ä¸ªåŸºäº QUIC åè®®çš„é«˜æ€§èƒ½ç½‘ç»œéš§é“å·¥å…·ï¼Œæ”¯æŒå°† TCP æµé‡é€šè¿‡ QUIC åè®®è¿›è¡Œè½¬å‘ã€‚

## é¡¹ç›®ç®€ä»‹

Ping Tunnel æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust å¼€å‘çš„ç½‘ç»œéš§é“å·¥å…·ï¼Œåˆ©ç”¨ QUIC åè®®çš„ä¼˜åŠ¿ï¼ˆä½å»¶è¿Ÿã€å¤šè·¯å¤ç”¨ã€å†…ç½®åŠ å¯†ï¼‰æ¥å®ç°é«˜æ•ˆçš„æµé‡è½¬å‘ã€‚é¡¹ç›®åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

- **Edge (å®¢æˆ·ç«¯)**: è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå°†æœ¬åœ°æµé‡é€šè¿‡ QUIC éš§é“è½¬å‘
- **Supernode (æœåŠ¡å™¨)**: æ¥æ”¶ QUIC è¿æ¥ï¼Œå¹¶å°†æµé‡è½¬å‘åˆ°ç›®æ ‡ TCP æœåŠ¡

## ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: åŸºäº QUIC åè®®ï¼Œæä¾›ä½å»¶è¿Ÿå’Œé«˜ååé‡
- ğŸ”’ **å®‰å…¨**: å†…ç½® TLS åŠ å¯†ï¼Œæ”¯æŒè¯ä¹¦è®¤è¯
- ğŸ”‘ **è®¤è¯**: æ”¯æŒ Token è®¤è¯æœºåˆ¶
- ğŸŒ **çµæ´»è½¬å‘**: æ”¯æŒåŠ¨æ€æŒ‡å®šè½¬å‘ç›®æ ‡
- ğŸ“¦ **Node.js æ”¯æŒ**: æä¾› Node.js åŸç”Ÿç»‘å®šï¼Œå¯åœ¨ Node.js é¡¹ç›®ä¸­ä½¿ç”¨
- âš¡ **å¼‚æ­¥æ¶æ„**: åŸºäº Tokio å¼‚æ­¥è¿è¡Œæ—¶ï¼Œæ”¯æŒé«˜å¹¶å‘

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         QUIC          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         TCP          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edge   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ Supernodeâ”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  NGINX  â”‚
â”‚(Client) â”‚                       â”‚ (Server) â”‚                      â”‚ Service â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Rust 1.70+ (æ¨èä½¿ç”¨ [rustup](https://rustup.rs/) å®‰è£…)
- Node.js 10+ (å¦‚æœä½¿ç”¨ Node.js SDK)

### ç¼–è¯‘

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd ping-tunnel

# ç¼–è¯‘é¡¹ç›®
cargo build --release
```

### ç”Ÿæˆè¯ä¹¦

æœåŠ¡å™¨éœ€è¦ TLS è¯ä¹¦ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼š

```bash
# åˆ›å»ºè¯ä¹¦ç›®å½•
mkdir -p cert

# ç”Ÿæˆç§é’¥
openssl genrsa -out cert/key.pem 2048

# ç”Ÿæˆè¯ä¹¦
openssl req -new -x509 -key cert/key.pem -out cert/cert.pem -days 365
```

### è¿è¡ŒæœåŠ¡å™¨ (Supernode)

```bash
cargo run --bin supernode -- \
  "0.0.0.0:4433" \
  "0.0.0.0:4432" \
  "./cert/cert.pem" \
  "./cert/key.pem"
```

å‚æ•°è¯´æ˜ï¼š

- `quic_bind_addr:port`: QUIC æœåŠ¡å™¨ç›‘å¬åœ°å€
- `tcp_bind_addr:port`: TCP æœåŠ¡å™¨ç›‘å¬åœ°å€ï¼ˆæ¥æ”¶ HTTP è¯·æ±‚ï¼‰
- `cert_path`: è¯ä¹¦æ–‡ä»¶è·¯å¾„
- `key_path`: ç§é’¥æ–‡ä»¶è·¯å¾„

### è¿è¡Œå®¢æˆ·ç«¯ (Edge)

```bash
cargo run --bin edge -- \
  "127.0.0.1:4433" \
  "my-secret-token" \
  "127.0.0.1:8080"
```

å‚æ•°è¯´æ˜ï¼š

- `server_addr`: æœåŠ¡å™¨åœ°å€
- `token`: è®¤è¯ Token
- `forward_to`: è½¬å‘ç›®æ ‡åœ°å€

## Node.js SDK

### å®‰è£…

```bash
cd node-sdk
npm install
```

### ä½¿ç”¨ç¤ºä¾‹

```javascript
const { EdgeClient } = require('./index.js');

// åˆ›å»ºå®¢æˆ·ç«¯
const client = new EdgeClient(
  '127.0.0.1:4433', // æœåŠ¡å™¨åœ°å€
  'my-secret-token', // è®¤è¯ Token
  '127.0.0.1:8080' // è½¬å‘ç›®æ ‡
);

// è¿æ¥åˆ°æœåŠ¡å™¨
client.connect();
```

æˆ–è€…ä½¿ç”¨å‡½æ•°å¼ APIï¼š

```javascript
const { connectToServer } = require('./index.js');

connectToServer('127.0.0.1:4433', 'my-secret-token', '127.0.0.1:8080');
```

## å·¥ä½œåŸç†

### è¿æ¥æµç¨‹

1. **å®¢æˆ·ç«¯è¿æ¥**: Edge å®¢æˆ·ç«¯é€šè¿‡ QUIC è¿æ¥åˆ° Supernode æœåŠ¡å™¨
2. **è®¤è¯**: å®¢æˆ·ç«¯å‘é€è®¤è¯ Token è¿›è¡Œèº«ä»½éªŒè¯
3. **å¿ƒè·³ä¿æŒ**: å®¢æˆ·ç«¯å®šæœŸå‘é€ Ping æ¶ˆæ¯ä¿æŒè¿æ¥
4. **æµé‡è½¬å‘**:
   - æœåŠ¡å™¨æ¥æ”¶ HTTP è¯·æ±‚ï¼ˆé€šè¿‡ TCPï¼‰
   - æ ¹æ®è¯·æ±‚å¤´ä¸­çš„ Token æ‰¾åˆ°å¯¹åº”çš„ QUIC è¿æ¥
   - å°†è¯·æ±‚è½¬å‘åˆ°å®¢æˆ·ç«¯æŒ‡å®šçš„ç›®æ ‡åœ°å€

### åè®®æ ¼å¼

é¡¹ç›®ä½¿ç”¨è‡ªå®šä¹‰çš„éš§é“åè®®ï¼Œæ”¯æŒä»¥ä¸‹å‘½ä»¤ï¼š

- `Ping/Pong`: å¿ƒè·³æ£€æµ‹
- `Auth/AuthResult`: èº«ä»½è®¤è¯
- `Forward`: æµé‡è½¬å‘
- `SetSessionMeta`: è®¾ç½®ä¼šè¯å…ƒæ•°æ®

### HTTP è¯·æ±‚å¤´

å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ HTTP è¯·æ±‚å¤´æ§åˆ¶è½¬å‘è¡Œä¸ºï¼š

- `X-Tunnel-Token`: è®¤è¯ Tokenï¼ˆå¿…éœ€ï¼‰
- `X-Tunnel-Forward-To`: åŠ¨æ€è½¬å‘ç›®æ ‡ï¼ˆå¯é€‰ï¼Œè¦†ç›–é»˜è®¤è½¬å‘åœ°å€ï¼‰

## å¼€å‘

### é¡¹ç›®ç»“æ„

```
ping-tunnel/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs          # åº“å…¥å£ï¼ŒåŒ…å« Node.js ç»‘å®š
â”‚   â”œâ”€â”€ edge.rs         # Edge å®¢æˆ·ç«¯äºŒè¿›åˆ¶
â”‚   â”œâ”€â”€ supernode.rs    # Supernode æœåŠ¡å™¨äºŒè¿›åˆ¶
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ client.rs   # å®¢æˆ·ç«¯é€»è¾‘
â”‚       â”œâ”€â”€ server.rs   # æœåŠ¡å™¨é€»è¾‘
â”‚       â”œâ”€â”€ forward.rs  # æµé‡è½¬å‘
â”‚       â”œâ”€â”€ packet.rs   # åè®®åŒ…å®šä¹‰
â”‚       â”œâ”€â”€ connections.rs # è¿æ¥ç®¡ç†
â”‚       â””â”€â”€ ...
â”œâ”€â”€ node-sdk/           # Node.js SDK
â””â”€â”€ cert/               # è¯ä¹¦ç›®å½•
```

### æ„å»º Node.js ç»‘å®š

```bash
# æ„å»ºå‘å¸ƒç‰ˆæœ¬
npm run build

# æ„å»ºè°ƒè¯•ç‰ˆæœ¬
npm run build:debug
```

## ä¾èµ–

ä¸»è¦ä¾èµ–ï¼š

- **quinn**: QUIC åè®®å®ç°
- **tokio**: å¼‚æ­¥è¿è¡Œæ—¶
- **rustls**: TLS å®ç°
- **napi**: Node.js åŸç”Ÿ API ç»‘å®š
- **dashmap**: å¹¶å‘å“ˆå¸Œæ˜ å°„

## æ³¨æ„äº‹é¡¹

- ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨æœ‰æ•ˆçš„ TLS è¯ä¹¦ï¼Œä¸è¦ä½¿ç”¨è‡ªç­¾åè¯ä¹¦
- Token åº”è¯¥è¶³å¤Ÿå¤æ‚ï¼Œå»ºè®®ä½¿ç”¨éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²
- æœåŠ¡å™¨ä¼šå®šæœŸæ¸…ç†ä¸æ´»è·ƒçš„è¿æ¥ï¼ˆé»˜è®¤ 60 ç§’æ— å¿ƒè·³ï¼‰
